<div id="page-content" x-data="notesPage()" x-init="init()" class="max-w-7xl mx-auto" x-cloak>
  <style>
    :root {
      --notes-accent: #0284c7; /* sky-600 - better contrast */
      --notes-accent-strong: #0369a1; /* sky-700 */
    }
    .notes-text { color: var(--notes-accent); }
    .notes-border { border-color: var(--notes-accent); }
    .notes-bg { background-color: var(--notes-accent); color: #fff; border-color: var(--notes-accent); }
  </style>
  <template x-if="loading">
    <div class="justify-center max-w-4xl mx-auto rounded-2xl border border-slate-200 dark:border-gray-800 bg-white dark:bg-gray-950 p-6 shadow-sm flex items-center gap-3 text-sm text-slate-600 dark:text-slate-300">
      <div class="h-5 w-5 rounded-full border-4 border-emerald-500 border-t-transparent animate-spin"></div>
      <span x-text="t('loading', 'Chargement de la page')"></span>
    </div>
  </template>
  <template x-if="!loading">      
    <section class="space-y-6">
      <div class="flex items-center justify-between gap-3">
        <div class="flex items-center gap-3">
          <span class="inline-flex h-11 w-11 items-center justify-center rounded-xl bg-sky-50 text-sky-600 dark:bg-sky-900/30">
            <i class="fa-solid fa-note-sticky text-lg"></i>
          </span>
          <div>
            <h1 class="text-2xl font-semibold inline-flex items-center gap-2 notes-text">
              <span x-text="t('title', 'Notes')"></span>
            </h1>
            <p class="text-sm text-slate-500 dark:text-slate-200" x-text="t('subtitle', 'Consultez et gérez l’ensemble des notes par scénario et session.')"></p>
          </div>
        </div>
      </div>
      <div class="space-y-4">
        <template x-if="groupedNotes().scenarios.length === 0 && groupedNotes().unlinked.length === 0">
          <div class="text-sm max-w-4xl mx-auto text-center text-slate-600 dark:text-slate-200 border border-dashed border-slate-300 dark:border-gray-800 rounded-lg p-4" x-text="t('none', 'Aucune note')"></div>
        </template>

        <div class="space-y-4 max-w-4xl mx-auto">
          <template x-for="grp in groupedNotes().scenarios" :key="grp.scenario.id">
            <div class="rounded-xl border border-slate-200 dark:border-gray-800 bg-white dark:bg-gray-950 p-4 shadow-sm space-y-3">
              <div class="text-lg font-semibold notes-text">
                <a class="hover:underline" :href="`/admin/scenarios/list.html?scenario=${encodeURIComponent(grp.scenario.id)}`" x-text="grp.scenario.title || grp.scenario.id"></a>
              </div>
              <template x-if="grp.singleSceneNotes.length">
                <div class="space-y-2">
                  <template x-for="note in grp.singleSceneNotes" :key="note.name">
                    <div class="rounded-lg border border-slate-200 dark:border-gray-800 bg-white dark:bg-gray-950 px-3 py-2 shadow-sm flex items-center justify-between gap-3">
                      <template x-if="note.sessionId">
                        <a class="font-semibold text-slate-900 dark:text-slate-100 truncate hover:underline"
                          :href="`/admin/sessions/view.html?id=${encodeURIComponent(note.sessionId)}${note.sceneId ? `&scene=${encodeURIComponent(note.sceneId)}` : ''}`"
                          x-text="note.sceneTitle || note.name"></a>
                      </template>
                      <template x-if="!note.sessionId">
                        <span class="font-semibold text-slate-900 dark:text-slate-100 truncate" x-text="note.sceneTitle || note.name"></span>
                      </template>
                          <div class="flex items-center gap-2 text-xs shrink-0">
                        <button class="h-8 w-8 inline-flex items-center justify-center rounded-lg border notes-border notes-text hover:bg-lime-50 dark:hover:bg-lime-900/30 transition" 
                                @click="openEdit(note)">
                          <i class="fa-solid fa-pen"></i> 
                        </button>
                        <button class="h-8 w-8 inline-flex items-center justify-center rounded-lg border border-rose-200 dark:border-rose-900 bg-white dark:bg-gray-950 text-rose-600 hover:bg-rose-50 dark:hover:bg-rose-900/20 transition"
                                    @click="openDelete(note)">
                              <i class="fa-solid fa-trash"></i> 
                            </button>
                          </div>
                    </div>
                  </template>
                </div>
              </template>

              <div class="space-y-2" x-show="grp.sessions.length">
                <template x-for="sess in grp.sessions" :key="sess.session.id">
                  <div class="rounded-lg border border-slate-200 dark:border-gray-800 bg-slate-50 dark:bg-gray-800/40 p-3 space-y-2">
                    <div class="flex items-center justify-between">
                      <a class="font-semibold text-slate-900 dark:text-slate-100 hover:underline"
                        :href="`/admin/sessions/view.html?id=${encodeURIComponent(sess.session.id)}`"
                        x-text="sess.session.title || sess.session.id"></a>
                    </div>
                    <div class="space-y-2">
                      <template x-for="note in sess.notes" :key="note.name">
                        <div class="rounded-lg border border-slate-200 dark:border-gray-700 bg-white dark:bg-gray-950 px-3 py-2 shadow-sm transition flex items-center justify-between gap-3">
                          <template x-if="note.sceneId">
                            <a class="font-semibold text-slate-900 dark:text-slate-100 truncate hover:underline"
                              :href="`/admin/sessions/view.html?id=${encodeURIComponent(sess.session.id)}&scene=${encodeURIComponent(note.sceneId)}`"
                              x-text="note.sceneTitle || note.name"></a>
                          </template>
                          <template x-if="!note.sceneId">
                            <span class="font-semibold text-slate-900 dark:text-slate-100 truncate" x-text="note.sceneTitle || note.name"></span>
                          </template>
                          <div class="flex items-center gap-2 text-xs shrink-0">
                        <button class="h-8 w-8 inline-flex items-center justify-center rounded-lg border notes-border notes-text hover:bg-lime-50 dark:hover:bg-lime-900/30 transition" 
                                @click="openEdit(note)">
                          <i class="fa-solid fa-pen"></i> 
                        </button>
                        <button class="h-8 w-8 inline-flex items-center justify-center rounded-lg border border-rose-200 dark:border-rose-900 bg-white dark:bg-gray-950 text-rose-600 hover:bg-rose-50 dark:hover:bg-rose-900/20 transition"
                                    @click="openDelete(note)">
                              <i class="fa-solid fa-trash"></i> 
                            </button>
                          </div>
                        </div>
                      </template>
                    </div>
                  </div>
                </template>
              </div>
            </div>
          </template>

          <template x-if="groupedNotes().unlinked.length">
            <div class="rounded-xl border border-slate-200 dark:border-gray-800 bg-white dark:bg-gray-950 p-4 shadow-sm space-y-2">
              <div class="text-lg font-semibold text-slate-900 dark:text-slate-100" x-text="t('unlinked', 'Non liées')"></div>
              <div class="space-y-2">
                <template x-for="note in groupedNotes().unlinked" :key="note.name">
                  <div class="rounded-lg border border-slate-200 dark:border-gray-700 bg-white dark:bg-gray-950 px-3 py-2 shadow-sm flex items-center justify-between gap-3">
                    <span class="font-semibold text-slate-900 dark:text-slate-100 truncate" x-text="note.name"></span>
                          <div class="flex items-center gap-2 text-xs shrink-0">
                        <button class="inline-flex items-center gap-1 px-2 py-1 rounded border border-sky-200 text-sky-700 dark:border-gray-700 dark:text-sky-300 hover:bg-sky-50 dark:hover:bg-slate-800 transition"
                                @click="openEdit(note)">
                          <i class="fa-solid fa-pen"></i> 
                        </button>
                        <button class="inline-flex items-center gap-1 px-2 py-1 rounded border border-rose-200 text-rose-600 hover:bg-rose-50 dark:hover:bg-rose-900/30 transition"
                                    @click="openDelete(note)">
                              <i class="fa-solid fa-trash"></i> 
                            </button>
                          </div>
                  </div>
                </template>
              </div>
            </div>
          </template>
        </div>
      </div>
    </section>
  </template>
  <div x-show="showEditModal" x-transition class="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-2xl w-full mx-4 p-4 space-y-3">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold notes-text" x-text="t('modals.editTitle', 'Éditer la note')"></h2>
        <button class="text-slate-500 hover:text-slate-800" @click="cancelModals()"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div class="text-sm text-slate-500 dark:text-slate-300" x-text="activeNote?.sceneTitle || activeNote?.name"></div>
      <textarea class="w-full h-64 border border-slate-200 dark:border-gray-700 rounded-lg p-3 font-mono text-sm bg-slate-50 dark:bg-slate-800"
                x-model="editContent"></textarea>
      <div class="flex justify-end gap-2">
        <button class="px-3 py-2 rounded-lg border border-slate-200 dark:border-gray-700 text-sm" @click="cancelModals()" x-text="t('actions.cancel', 'Annuler')"></button>
        <button class="px-3 py-2 rounded-lg notes-bg text-sm font-semibold hover:brightness-110 transition"
                @click="saveEdit()" x-text="t('actions.save', 'Enregistrer')"></button>
      </div>
    </div>
  </div>

  <div x-show="showDeleteModal" x-transition class="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-md w-full mx-4 p-4 space-y-3">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold text-rose-600" x-text="t('modals.deleteTitle', 'Supprimer la note')"></h2>
        <button class="text-slate-500 hover:text-slate-800" @click="cancelModals()"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <p class="text-sm text-slate-600 dark:text-slate-300">
        <span x-text="t('modals.deleteConfirm', 'Confirmer la suppression de la note {name} ?').replace('{name}', activeNote?.sceneTitle || activeNote?.name || '')"></span>
      </p>
      <div class="flex justify-end gap-2">
        <button class="px-3 py-2 rounded-lg border border-slate-200 dark:border-gray-700 text-sm" @click="cancelModals()" x-text="t('actions.cancel', 'Annuler')"></button>
        <button class="px-3 py-2 rounded-lg border border-rose-200 text-rose-600 text-sm font-semibold hover:bg-rose-50 dark:hover:bg-rose-900/30 transition"
                @click="confirmDelete()" x-text="t('actions.delete', 'Supprimer')"></button>
      </div>
    </div>
  </div>
</div>
<script src="/admin/js/layout-loader.js"></script>
<script type="module" src="/admin/notes/notes.js" data-page-script></script>
