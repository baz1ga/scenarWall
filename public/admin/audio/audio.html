<div id="page-content" x-data="audioPage()" x-init="init()" class="max-w-7xl mx-auto" x-cloak>
  <style>
    :root {
      --audio-accent: #65a30d; /* lime-600 */
      --audio-accent-strong: #4d7c0f; /* lime-700 */
    }
    .audio-text { color: var(--audio-accent); }
    .audio-border { border-color: var(--audio-accent); }
    .audio-bg { background-color: var(--audio-accent); color: #fff; border-color: var(--audio-accent); }
    .audio-ring { box-shadow: 0 0 0 2px var(--audio-accent); }
  </style>
  <template x-if="audioLoading">
    <div class="justify-center max-w-4xl mx-auto rounded-2xl border border-slate-200 dark:border-gray-800 bg-white dark:bg-gray-950 p-6 shadow-sm flex items-center gap-3 text-sm text-slate-600 dark:text-slate-300">
      <div class="h-5 w-5 rounded-full border-4 border-emerald-500 border-t-transparent animate-spin"></div>
      <span x-text="t('loading', 'Chargement de la page')"></span>
    </div>
  </template>
  <template x-if="!audioLoading">    
    <section class="space-y-6">
      <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
        <div class="flex items-center gap-3">
          <span class="inline-flex h-11 w-11 items-center justify-center rounded-xl bg-lime-50 text-lime-700 dark:bg-lime-900/30">
            <i class="fa-solid fa-music text-lg"></i>
          </span>
          <div>
            <h1 class="text-2xl font-semibold audio-text" x-text="t('title', 'Fichiers audio')"></h1>
            <p class="text-sm text-slate-500 dark:text-slate-200" x-text="t('subtitle', 'Bibliothèque audio disponible pour vos scènes.')"></p>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <div class="inline-flex items-center gap-2" x-show="tenantId">
            <input type="file" class="hidden" multiple accept="audio/*" @change="uploadAudio($event)" x-ref="audioInput">
            <button type="button"
                    class="inline-flex items-center gap-2 h-10 rounded-lg bg-lime-500 text-slate-900 font-semibold px-4 text-sm shadow-sm hover:bg-lime-400 transition"
                    @click="$refs.audioInput.click()"
                    :aria-label="t('buttons.upload', 'Upload audio (< 1 MB)')"
                    :title="t('buttons.upload', 'Upload audio (< 1 MB)')">
              <i class="fa-solid fa-upload"></i> <span x-text="t('upload', 'Ajouter (< 1 Mo)')"></span>
            </button>
          </div>
        </div>
      </div>
      <template x-if="!audioLoading && audioFiles.length === 0">
        <div class="text-sm max-w-4xl mx-auto text-center text-slate-600 dark:text-slate-200 border border-dashed border-slate-300 dark:border-gray-800 rounded-lg p-4" x-text="t('none', 'Aucun audio')"></div>
      </template>
      <div class="space-y-2 max-w-4xl mx-auto" x-show="!audioLoading && audioFiles.length > 0">
        <template x-for="(audio, index) in audioFiles" :key="audio.name">
          <div
            class="flex items-center gap-3 rounded-xl border border-slate-200 dark:border-gray-800 bg-white dark:bg-gray-950 p-3 transition"
            draggable="true"
            @dragstart="startAudioDrag(index)"
            @dragend="endAudioDrag()"
            @dragover.prevent="onAudioDragOver(index)"
            @drop.prevent="onAudioDrop(index)"
            :class="[
              audioDragOverIndex === index && audioDragIndex !== null ? 'audio-ring ring-offset-2 ring-offset-slate-50 dark:ring-offset-slate-900 shadow-lg' : '',
              audioDragIndex === index ? 'opacity-80 scale-[0.99]' : ''
            ]"
          >
            <button
              class="h-8 w-8 inline-flex items-center justify-center rounded-lg border bg-white/90 dark:bg-gray-800/90 text-slate-500 dark:text-white hover:text-lime-600 dark:hover:text-white border border-slate-200 dark:border-gray-700 cursor-grab select-none"
              :class="audioDragIndex === index ? 'cursor-grabbing audio-text' : ''"
              :title="t('reorderHint', 'Glisser pour réordonner')"
              draggable="true"
              @dragstart.stop="startAudioDrag(index)"
              @dragend.stop="endAudioDrag()"
            >
              <i class="fa-solid fa-grip-vertical text-sm"></i>
            </button>
            <div class="flex-1">
              <div class="text-sm font-semibold truncate" x-text="audio.name"></div>
            </div>
            <audio :src="audio.url" controls class="w-80 h-10"></audio>
            <div class="flex items-center gap-2">
              <button
                class="h-8 w-8 inline-flex items-center justify-center rounded-lg border audio-border audio-text hover:bg-lime-50 dark:hover:bg-lime-900/30 transition"
                @click="openRenameAudioModal(audio.name)"
                :aria-label="t('buttons.rename', 'Rename audio')"
                :title="t('buttons.rename', 'Rename audio')"
              >
                <i class="fa-solid fa-pen"></i>
              </button>
              <button
                class="h-8 w-8 inline-flex items-center justify-center rounded-lg border border-rose-200 dark:border-rose-900 bg-white dark:bg-gray-950 text-rose-600 hover:bg-rose-50 dark:hover:bg-rose-900/20 transition"
                @click="deleteAudio(audio.name)"
                :aria-label="t('buttons.delete', 'Delete audio')"
                :title="t('buttons.delete', 'Delete audio')"
              >
                <i class="fa-solid fa-trash"></i>
              </button>
        </div>
          </div>
        </template>
      </div>
      <div class="text-sm" :class="audioStatus === 'error' ? 'text-rose-500 dark:text-rose-400' : 'text-emerald-600 dark:text-emerald-300'" x-text="audioMessage"></div>
    </section>
  </template>
  <div
    class="fixed inset-0 z-50 flex items-center justify-center px-4"
    x-show="renameAudioModal.open"
    x-transition
    x-cloak
    @keydown.escape.window="closeRenameAudioModal()"
  >
    <div class="fixed inset-0 bg-black/60" @click="closeRenameAudioModal()"></div>
    <div class="relative w-full max-w-md rounded-2xl bg-white dark:bg-gray-800 border border-slate-200 dark:border-gray-800 shadow-2xl p-6 space-y-4">
      <div class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-full flex items-center justify-center text-xl audio-text" style="background: rgba(101,163,13,0.15);">
          <i class="fa-solid fa-pen"></i>
        </div>
        <div class="text-lg font-semibold text-slate-900 dark:text-slate-100" x-text="t('renameDialog.title', `Renommer l'audio`)"></div>
      </div>
      <p class="text-sm text-slate-600 dark:text-slate-300"><span x-text="t('renameDialog.current', 'Nom actuel :')"></span> <span class="font-semibold" x-text="renameAudioModal.name"></span></p>
      <div class="space-y-2">
        <label class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-200 font-semibold" x-text="t('renameDialog.label', 'Nouveau nom')"></label>
        <input
          type="text"
          class="w-full rounded-lg border bg-white dark:bg-slate-800 px-3 py-2 text-sm focus:ring-2 focus:outline-none"
          style="border-color: var(--audio-accent); --tw-ring-color: var(--audio-accent);"
          x-model="renameAudioModal.newName"
          :placeholder="t('renameDialog.placeholder', 'ex: ambiance.mp3')"
        >
        <p class="text-xs text-rose-500" x-text="renameAudioModal.error" x-show="renameAudioModal.error"></p>
      </div>
      <div class="flex justify-end gap-2 pt-2">
        <button class="px-4 py-2 rounded-lg border border-slate-300 dark:border-gray-700 text-slate-700 dark:text-slate-100 hover:bg-slate-100 dark:hover:bg-slate-800" @click="closeRenameAudioModal()" x-text="t('renameDialog.cancel', 'Annuler')"></button>
        <button class="px-4 py-2 rounded-lg audio-bg font-semibold hover:brightness-110" @click="confirmRenameAudio()" x-text="t('renameDialog.confirm', 'Renommer')"></button>
      </div>
    </div>
  </div>

  <div
    class="fixed inset-0 z-50 flex items-center justify-center px-4"
    x-show="confirmModal.open"
    x-transition
    x-cloak
    @keydown.escape.window="closeConfirm()"
  >
    <div class="fixed inset-0 bg-black/60" @click="closeConfirm()"></div>
    <div class="relative w-full max-w-md rounded-2xl bg-white dark:bg-gray-800 border border-slate-200 dark:border-gray-800 shadow-2xl p-6 space-y-4">
      <div class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-full bg-amber-100 text-amber-700 flex items-center justify-center text-xl">
          <i class="fa-solid fa-triangle-exclamation"></i>
        </div>
        <div class="text-lg font-semibold text-slate-900 dark:text-slate-100" x-text="t('confirm.title', 'Confirmation')"></div>
      </div>
      <p class="text-sm text-slate-600 dark:text-slate-300" x-text="confirmModal.message"></p>
      <div class="flex justify-end gap-2 pt-2">
        <button class="px-4 py-2 rounded-lg border border-slate-300 dark:border-gray-700 text-slate-700 dark:text-slate-100 hover:bg-slate-100 dark:hover:bg-slate-800" @click="closeConfirm()" x-text="t('confirm.cancel', 'Annuler')"></button>
        <button class="px-4 py-2 rounded-lg bg-rose-600 text-white font-semibold hover:bg-rose-500" @click="confirmYes()" x-text="t('confirm.confirm', 'Confirmer')"></button>
      </div>
    </div>
  </div>
</div>
<script src="/admin/js/layout-loader.js"></script>
<script type="module" src="/admin/audio/audio.js" data-page-script></script>
