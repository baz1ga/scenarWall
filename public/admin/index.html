<!DOCTYPE html>
<html lang="fr" x-data="dashboard()" x-init="init()" x-bind:class="theme === 'dark' ? 'dark' : ''" class="min-h-screen">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ScenarWall – Administration</title>
  <link rel="stylesheet" href="/css/tailwind.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script>
    (()=>{
      const saved = localStorage.getItem('sw_theme');
      const prefers = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      const mode = saved || prefers;
      document.documentElement.classList.toggle('dark', mode === 'dark');
    })();
  </script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script src="/js/common/config.js"></script>
  <script src="/js/common/auth.js"></script>
  <script src="/js/common/fragments-loader.js" defer></script>
  <style>
    @font-face {
      font-family: 'Pangolin';
      src: url('/assets/font/Pangolin-Regular.ttf') format('truetype');
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }
    .font-pangolin { font-family: 'Pangolin', 'Comic Sans MS', cursive; }
    [x-cloak]{display:none!important}
  </style>
</head>
<body class="min-h-screen flex bg-slate-50 text-slate-900 dark:bg-slate-900 dark:text-slate-100">
  <!-- Sidebar -->
  <aside class="w-64 bg-white dark:bg-slate-950 border-r border-slate-200 dark:border-slate-800 flex flex-col">
    <div class="px-6 py-5 flex items-center justify-center">
        <div class="text-3xl font-semibold text-emerald-500 font-pangolin text-center">.ScenarWall.</div>
    </div>
    <nav class="flex-1 px-3 space-y-1">
      <button @click="section = 'galerie'" :class="section === 'galerie' ? 'bg-slate-800 text-emerald-300' : 'text-slate-700 dark:text-slate-200 hover:bg-slate-200/70 hover:text-slate-900 dark:hover:bg-slate-800'" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium text-left" x-show="tenantId">
        <i class="fa-regular fa-image text-base"></i>
        <span>Galerie</span>
      </button>
      <button @click="section = 'audio'; loadAudio()" :class="section === 'audio' ? 'bg-slate-800 text-indigo-300' : 'text-slate-700 dark:text-slate-200 hover:bg-slate-200/70 hover:text-slate-900 dark:hover:bg-slate-800'" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium text-left" x-show="tenantId">
        <i class="fa-solid fa-music text-base"></i>
        <span>Audio</span>
      </button>
      <button @click="section = 'tension'" :class="section === 'tension' ? 'bg-slate-800 text-amber-300' : 'text-slate-700 dark:text-slate-200 hover:bg-slate-200/70 hover:text-slate-900 dark:hover:bg-slate-800'" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium text-left" x-show="tenantId">
        <i class="fa-solid fa-bolt text-base"></i>
        <span>Tension</span>
      </button>
      <button @click="section = 'users'" :class="section === 'users' ? 'bg-slate-800 text-sky-300' : 'text-slate-700 dark:text-slate-200 hover:bg-slate-200/70 hover:text-slate-900 dark:hover:bg-slate-800'" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium text-left" x-show="isSuperAdmin">
        <i class="fa-solid fa-users text-base"></i>
        <span>Utilisateurs</span>
      </button>
    </nav>
    <div class="px-4 py-4 text-xs text-slate-500 space-y-3">
      <div data-include="donation-box"></div>
      <div data-include="legal-footer" data-variant="auth"></div>
    </div>
  </aside>

  <!-- Main -->
  <div class="flex-1 flex flex-col min-h-screen bg-slate-50 dark:bg-slate-900">
    <!-- Top bar -->
    <header class="flex items-center px-6 py-4 border-b border-slate-200 dark:border-slate-800 bg-white/80 dark:bg-slate-900 backdrop-blur">
      <div class="flex-1"></div>
      <div class="hidden md:flex items-center gap-3 justify-center" x-show="tenantId">
        <div class="hidden md:flex items-center gap-2 rounded-lg border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-950 px-3 py-1.5 text-xs">
          <div class="w-28">
            <div class="text-[11px] text-slate-500 dark:text-slate-400" x-text="quotaDisplay">—</div>
            <div class="mt-1 h-1.5 w-full rounded-full bg-slate-800 overflow-hidden">
              <div class="h-full bg-emerald-500 transition-all" :style="`width:${quotaPercent}%`"></div>
            </div>
          </div>
        </div>
        <button class="hidden md:inline-flex items-center gap-3 rounded-lg border border-emerald-500 bg-emerald-500 text-slate-900 font-semibold px-5 py-2.5 text-sm hover:bg-emerald-400 dark:bg-slate-950 dark:border-slate-800 dark:text-emerald-200 dark:hover:bg-slate-800" @click="openFront">
          <i class="fa-solid fa-film"></i> Présenter
        </button>
      </div>
      <div class="flex-1 flex justify-end">
        <div class="flex items-center gap-3">
          <button class="p-2 inline-flex items-center justify-center text-slate-700 dark:text-slate-100 hover:text-emerald-500 transition-colors"
                  @click="toggleTheme()"
                  :aria-label="theme === 'dark' ? 'Passer en mode clair' : 'Passer en mode sombre'"
                  :title="theme === 'dark' ? 'Mode clair' : 'Mode sombre'">
            <i :class="theme === 'dark' ? 'fa-regular fa-sun' : 'fa-solid fa-moon'"></i>
          </button>
          <div class="relative" @click.outside="userMenu=false">
            <button class="h-10 w-10 rounded-full bg-emerald-500 text-slate-900 font-semibold flex items-center justify-center hover:bg-emerald-400 overflow-hidden"
                    @click.stop="userMenu = !userMenu">
              <template x-if="avatarUrl">
                <img :src="avatarUrl" alt="Avatar" class="h-full w-full object-cover">
              </template>
              <template x-if="!avatarUrl">
                <span class="text-sm font-semibold" x-text="avatarInitial"></span>
              </template>
            </button>
            <div class="absolute right-0 mt-2 w-56 bg-white text-slate-800 dark:bg-slate-800 dark:text-slate-100 rounded-xl border border-slate-200 dark:border-slate-700 shadow-lg" x-show="userMenu" x-transition x-cloak>
              <div class="px-4 py-2 text-xs text-slate-500 dark:text-slate-400 border-b border-slate-200 dark:border-slate-700">
                Logged as <span class="font-semibold text-slate-800 dark:text-slate-100" x-text="displayName || '—'"></span>
              </div>
              <button class="w-full text-left px-4 py-2 text-sm text-rose-600 dark:text-rose-300 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-b-xl inline-flex items-center gap-2" @click="logout()">
                <i class="fa-solid fa-arrow-right-from-bracket"></i> <span>Logout</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Content -->
    <main class="flex-1 p-6 bg-slate-50 dark:bg-slate-900 space-y-6">
      <!-- Galerie -->
      <section x-show="section === 'galerie'" x-cloak class="space-y-6 max-w-5xl mx-auto mt-6">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold">Images visibles</h2>
          <label class="cursor-pointer inline-flex items-center gap-2 text-sm text-emerald-600 dark:text-emerald-300" x-show="tenantId">
            <input type="file" class="hidden" multiple @change="uploadFile($event)">
            <span class="inline-flex items-center gap-2 rounded-lg border border-emerald-500 px-3 py-1.5 text-emerald-800 dark:text-emerald-100 bg-white dark:bg-transparent hover:bg-emerald-500/10"><i class="fa-solid fa-upload"></i> Ajouter</span>
          </label>
        </div>
        <div class="space-y-2">
          <template x-if="galleryLoading">
            <div class="text-sm text-slate-400">Chargement...</div>
          </template>
          <template x-if="!galleryLoading && visible.length === 0">
            <div class="text-sm text-slate-600 dark:text-slate-400 border border-dashed border-slate-300 dark:border-slate-800 rounded-lg p-4">Aucune image visible.</div>
          </template>
          <template x-for="(img, index) in visible" :key="img.name">
            <div class="flex items-center gap-3 rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-950 p-3">
              <img :src="img.url" class="h-16 w-16 object-cover rounded-lg border border-slate-800" @click="zoom(img.url)">
              <div class="flex-1">
                <div class="text-sm font-semibold truncate" x-text="img.name"></div>
              </div>
                <div class="flex items-center gap-2 text-sm">
                  <button class="px-2 py-1 rounded border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-800 dark:text-slate-100 hover:bg-slate-100 dark:hover:bg-slate-700" @click="move(index, -1)"><i class="fa-solid fa-arrow-up"></i></button>
                  <button class="px-2 py-1 rounded border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-800 dark:text-slate-100 hover:bg-slate-100 dark:hover:bg-slate-700" @click="move(index, 1)"><i class="fa-solid fa-arrow-down"></i></button>
                  <button class="px-2 py-1 rounded bg-amber-500 text-slate-900 font-semibold hover:bg-amber-400" @click="hideImage(img.name)"><i class="fa-regular fa-eye-slash mr-1"></i>Cacher</button>
                </div>
            </div>
          </template>
        </div>

        <div class="space-y-4">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-semibold">Images cachées</h2>
          </div>
          <div class="space-y-2">
            <template x-if="galleryLoading">
              <div class="text-sm text-slate-400">Chargement...</div>
            </template>
            <template x-if="!galleryLoading && hidden.length === 0">
              <div class="text-sm text-slate-600 dark:text-slate-400 border border-dashed border-slate-300 dark:border-slate-800 rounded-lg p-4">Aucune image cachée.</div>
            </template>
            <template x-for="img in hidden" :key="img.name">
            <div class="flex items-center gap-3 rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-950 p-3">
                <img :src="img.url" class="h-14 w-14 object-cover rounded-lg border border-slate-800" @click="zoom(img.url)">
                <div class="flex-1">
                  <div class="text-sm font-semibold truncate" x-text="img.name"></div>
                </div>
                <div class="flex items-center gap-2 text-sm">
                  <button class="px-2 py-1 rounded bg-emerald-500 text-slate-900 font-semibold hover:bg-emerald-400" @click="showImage(img.name)"><i class="fa-regular fa-eye mr-1"></i>Afficher</button>
                  <button class="px-2 py-1 rounded bg-rose-600 text-white font-semibold hover:bg-rose-500" @click="deleteImage(img.name)">
                    <i class="fa-solid fa-trash"></i>
                  </button>
                </div>
              </div>
            </template>
          </div>
          <div class="text-sm" :class="uploadStatus === 'error' ? 'text-rose-500 dark:text-rose-400' : 'text-emerald-600 dark:text-emerald-300'" x-text="uploadMessage"></div>
        </div>
      </section>

      <!-- Audio -->
      <section x-show="section === 'audio'" x-cloak class="space-y-6 max-w-5xl mx-auto">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold">Fichiers audio</h2>
          <label class="cursor-pointer inline-flex items-center gap-2 text-sm text-indigo-600 dark:text-indigo-300" x-show="tenantId">
            <input type="file" class="hidden" multiple accept="audio/*" @change="uploadAudio($event)">
            <span class="inline-flex items-center gap-2 rounded-lg border border-indigo-500 px-3 py-1.5 text-indigo-800 dark:text-indigo-100 bg-white dark:bg-transparent hover:bg-indigo-500/10"><i class="fa-solid fa-upload"></i> Ajouter (&lt; 1 Mo)</span>
          </label>
        </div>
        <template x-if="audioLoading">
          <div class="text-sm text-slate-400">Chargement...</div>
        </template>
        <template x-if="!audioLoading && audioFiles.length === 0">
          <div class="text-sm text-slate-600 dark:text-slate-400 border border-dashed border-slate-300 dark:border-slate-800 rounded-lg p-4">Aucun fichier audio.</div>
        </template>
        <div class="space-y-2" x-show="!audioLoading && audioFiles.length > 0">
          <template x-for="audio in audioFiles" :key="audio.name">
            <div class="flex items-center gap-3 rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-950 p-3">
              <div class="flex-1">
                <div class="text-sm font-semibold truncate" x-text="audio.name"></div>
                <div class="text-xs text-slate-500" x-text="formatBytes(audio.size)"></div>
              </div>
              <audio :src="audio.url" controls class="w-60 h-10"></audio>
              <button class="px-2 py-1 rounded border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-100 hover:bg-slate-100 dark:hover:bg-slate-800 inline-flex items-center gap-1" @click="renameAudio(audio.name)">
                <i class="fa-solid fa-pen"></i>
              </button>
              <button class="px-2 py-1 rounded bg-rose-600 text-white hover:bg-rose-500 inline-flex items-center gap-1" @click="deleteAudio(audio.name)">
                <i class="fa-solid fa-trash"></i>
              </button>
            </div>
          </template>
        </div>
        <div class="text-sm" :class="audioStatus === 'error' ? 'text-rose-500 dark:text-rose-400' : 'text-emerald-600 dark:text-emerald-300'" x-text="audioMessage"></div>
      </section>

      <!-- Tension -->
      <section x-show="section === 'tension'" x-cloak class="space-y-6 max-w-5xl mx-auto">
        <div class="flex flex-col items-center gap-4 md:flex-row md:flex-wrap md:justify-center md:items-start">
          <div class="w-full md:max-w-3xl mx-auto rounded-2xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-950 p-6 shadow-sm space-y-3">
            <div class="flex items-center justify-between">
              <div>
                <h2 class="text-lg font-semibold" x-text="tensionEnabled ? 'Barre de tension activée' : 'Barre de tension désactivée'"></h2>
              </div>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" class="sr-only peer" x-model="tensionEnabled" @change="saveTensionConfig">
                <div class="w-11 h-6 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:bg-emerald-500 transition"></div>
                <div class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition peer-checked:translate-x-5"></div>
              </label>
            </div>
          </div>
          <div class="w-full md:max-w-3xl mx-auto rounded-2xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-950 p-6 shadow-sm space-y-3">
            <p class="text-sm text-slate-400">Police de la barre de tension</p>
          <div class="grid gap-3 sm:grid-cols-2">
            <label class="flex items-center gap-2 rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 px-3 py-2 text-sm text-slate-900 dark:text-slate-100 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800">
              <input type="radio" class="text-emerald-500" name="tensionFont" value="Audiowide" x-model="tensionFont" @change="saveTensionConfig">
              <span style="font-family: 'Audiowide', sans-serif;" class="text-lg">Futuriste (Audiowide)</span>
            </label>
            <label class="flex items-center gap-2 rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 px-3 py-2 text-sm text-slate-900 dark:text-slate-100 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800">
              <input type="radio" class="text-emerald-500" name="tensionFont" value="Metal Mania" x-model="tensionFont" @change="saveTensionConfig">
              <span style="font-family: 'Metal Mania', cursive;" class="text-lg">Horrifique (Metal Mania)</span>
            </label>
            <label class="flex items-center gap-2 rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 px-3 py-2 text-sm text-slate-900 dark:text-slate-100 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800">
              <input type="radio" class="text-emerald-500" name="tensionFont" value="Rye" x-model="tensionFont" @change="saveTensionConfig">
              <span style="font-family: 'Rye', cursive;" class="text-lg">Saloon (Rye)</span>
            </label>
            <label class="flex items-center gap-2 rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 px-3 py-2 text-sm text-slate-900 dark:text-slate-100 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800">
              <input type="radio" class="text-emerald-500" name="tensionFont" value="Share Tech Mono" x-model="tensionFont" @change="saveTensionConfig">
              <span style="font-family: 'Share Tech Mono', monospace;" class="text-lg">Techno (Share Tech Mono)</span>
            </label>
            <label class="flex items-center gap-2 rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 px-3 py-2 text-sm text-slate-900 dark:text-slate-100 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800">
              <input type="radio" class="text-emerald-500" name="tensionFont" value="Bangers" x-model="tensionFont" @change="saveTensionConfig">
              <span style="font-family: 'Bangers', cursive;" class="text-lg">Cartoon (Bangers)</span>
            </label>
            <label class="flex items-center gap-2 rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 px-3 py-2 text-sm text-slate-900 dark:text-slate-100 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800">
              <input type="radio" class="text-emerald-500" name="tensionFont" value="Great Vibes" x-model="tensionFont" @change="saveTensionConfig">
              <span style="font-family: 'Great Vibes', cursive;" class="text-lg">Manuscrit (Great Vibes)</span>
            </label>
          </div>
        </div>
          <div class="w-full md:max-w-3xl mx-auto rounded-2xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-950 p-6 shadow-sm space-y-4">
            <div class="flex items-center justify-between">
              <p class="text-sm text-slate-400">Personnaliser les niveaux</p>
            </div>
            <div class="space-y-2">
              <template x-for="level in ['level1','level2','level3','level4','level5']" :key="level">
                <div class="rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 px-3 py-2 text-sm text-slate-900 dark:text-slate-100">
                  <div class="flex flex-wrap items-center gap-3">
                    <span class="font-semibold" x-text="`Niveau ${level.replace('level','')}`"></span>
                    <div class="ml-auto flex items-center gap-3 flex-wrap justify-end">
                      <div class="flex items-center gap-2">
                        <span class="text-xs text-slate-500 dark:text-slate-400">Label</span>
                        <input type="text" maxlength="4" class="w-20 rounded border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 px-2 py-1 text-sm text-slate-900 dark:text-slate-100" x-model="tensionLabels[level]" @change="saveTensionConfig">
                      </div>
                      <div class="flex items-center gap-2">
                        <span class="text-xs text-slate-500 dark:text-slate-400">Couleur</span>
                        <input type="color" class="h-9 w-12 rounded border border-slate-300 dark:border-slate-700 bg-transparent cursor-pointer" x-model="tensionColors[level]" @change="saveTensionConfig">
                      </div>
                      <div class="flex items-center gap-2 min-w-[160px]">
                        <span class="text-xs text-slate-500 dark:text-slate-400 whitespace-nowrap">Audio</span>
                        <select class="flex-1 rounded border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 px-2 py-1 text-sm text-slate-900 dark:text-slate-100"
                                x-model="tensionAudio[level]"
                                @change="saveTensionConfig">
                          <option :value="null">Aucun</option>
                          <template x-for="audio in audioFiles" :key="audio.name">
                            <option :value="audio.name" x-text="audio.name"></option>
                          </template>
                        </select>
                      </div>
                    </div>
                  </div>
                </div>
              </template>
            </div>
          </div>
        </div>
        <div class="text-sm" :class="tensionStatus === 'error' ? 'text-rose-500 dark:text-rose-400' : 'text-emerald-600 dark:text-emerald-300'" x-text="tensionMessage"></div>
      </section>

      <!-- Utilisateurs (GodMode) -->
      <section x-show="section === 'users' && isSuperAdmin" x-cloak class="space-y-6 max-w-5xl mx-auto">
        <div class="flex items-center justify-between"></div>
        <div class="flex flex-col lg:flex-row gap-4">
          <div class="flex-1 rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-950 p-3 space-y-2 shadow-sm">
          <div class="flex flex-wrap items-center gap-3">
            <div class="flex items-center gap-2">
              <div class="font-semibold whitespace-nowrap">Quota global par défaut (Mo)</div>
              <div class="text-sm" :class="globalQuotaStatus === 'error' ? 'text-rose-500 dark:text-rose-400' : 'text-emerald-600 dark:text-emerald-300'" x-text="globalQuotaMessage"></div>
            </div>
            <div class="flex flex-wrap items-center gap-3 ml-auto">
              <div class="flex items-center gap-3">
                <input type="number" min="1" step="1" class="w-32 sm:w-40 rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 px-3 py-2 text-sm text-slate-900 dark:text-slate-100" x-model.number="globalQuotaValue">
                <button class="rounded-lg border border-emerald-500 bg-emerald-500 text-slate-900 font-semibold px-3 py-2 text-sm hover:bg-emerald-400 dark:bg-slate-900 dark:border-slate-700 dark:text-slate-100 dark:hover:bg-slate-800" @click="saveGlobalQuota">Mettre à jour</button>
              </div>
            </div>
          </div>
        </div>
          <div class="lg:w-64 rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-950 p-3 shadow-sm flex items-center justify-between">
            <div class="font-semibold text-slate-900 dark:text-slate-100">Total usages</div>
            <div class="text-sm text-slate-700 dark:text-slate-200" x-text="totalUsageText()"></div>
          </div>
        </div>
        <div class="overflow-x-auto rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-950 shadow-sm">
          <table class="min-w-full text-sm">
            <thead class="bg-slate-100 text-slate-800 dark:bg-slate-800 dark:text-slate-200">
              <tr>
                <th class="px-4 py-2 text-left cursor-pointer" @click="setUserSort('name')">
                  <div class="inline-flex items-center gap-2">Nom <i :class="sortIcon('name','users')" class="text-xs"></i></div>
                </th>
                <th class="px-4 py-2 text-left">Tenant</th>
                <th class="px-4 py-2 text-left cursor-pointer" @click="setUserSort('images')">
                  <div class="inline-flex items-center gap-2">Images <i :class="sortIcon('images','users')" class="text-xs"></i></div>
                </th>
                <th class="px-4 py-2 text-left cursor-pointer" @click="setUserSort('audios')">
                  <div class="inline-flex items-center gap-2">Audio <i :class="sortIcon('audios','users')" class="text-xs"></i></div>
                </th>
                <th class="px-4 py-2 text-left cursor-pointer" @click="setUserSort('usage')">
                  <div class="inline-flex items-center gap-2">Usage <i :class="sortIcon('usage','users')" class="text-xs"></i></div>
                </th>
                <th class="px-4 py-2 text-left cursor-pointer" @click="setUserSort('lastLogin')">
                  <div class="inline-flex items-center gap-2">Dernière connexion <i :class="sortIcon('lastLogin','users')" class="text-xs"></i></div>
                </th>
                <th class="px-4 py-2 text-left">Actions</th>
              </tr>
            </thead>
            <tbody>
              <template x-if="usersLoading">
                <tr><td colspan="7" class="px-4 py-3 text-center text-slate-400">Chargement...</td></tr>
              </template>
              <template x-if="!usersLoading && filteredUsers('users').length === 0">
                <tr><td colspan="7" class="px-4 py-3 text-center text-slate-500">Aucun utilisateur</td></tr>
              </template>
              <template x-for="u in filteredUsers('users')" :key="u.email">
                <tr class="border-t border-slate-200 dark:border-slate-800">
                  <td class="px-4 py-2"><div class="flex items-center gap-2"><template x-if="u.admin"><i class="fa-solid fa-crown text-amber-400"></i></template><span x-text="u.displayName || u.email"></span></div></td>
                  <td class="px-4 py-2" x-text="u.tenantId || '—'"></td>
                  <td class="px-4 py-2" x-text="u.imageCount || 0"></td>
                  <td class="px-4 py-2" x-text="u.audioCount || 0"></td>
                  <td class="px-4 py-2">
                    <div class="w-36 sm:w-44 h-2 rounded-full bg-slate-800 overflow-hidden" :title="usageTitle(u)">
                      <div class="h-full bg-emerald-500" :style="`width:${usageData(u).percent}%`"></div>
                    </div>
                    <div class="text-xs text-slate-400" x-text="usageData(u).text"></div>
                  </td>
                  <td class="px-4 py-2" x-text="u.lastLogin ? new Date(u.lastLogin).toLocaleString('fr-FR') : '—'"></td>
                  <td class="px-4 py-2">
                    <div class="flex items-center gap-2">
                      <button class="px-2 py-1 inline-flex items-center rounded border border-emerald-500 bg-emerald-500 text-slate-900 font-semibold hover:bg-emerald-400 dark:bg-slate-800 dark:border-slate-700 dark:text-slate-100 dark:hover:bg-slate-700" @click="editTenantQuota(u)">
                        <i class="fa-solid fa-chart-pie"></i>
                      </button>
                      <template x-if="!u.admin">
                        <button class="px-2 py-1 rounded bg-rose-600 text-white hover:bg-rose-500 inline-flex items-center gap-1" @click="deleteUser(u.email)">
                          <i class="fa-solid fa-trash"></i>
                        </button>
                      </template>
                    </div>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

  <!-- Zoom overlay -->
  <div class="fixed inset-0 bg-black/80 flex items-center justify-center z-50" x-show="zoomUrl" x-transition x-cloak>
    <div class="relative max-w-4xl w-full px-6">
      <button class="absolute -top-10 right-0 text-slate-200 text-xl" @click="zoomUrl = ''">✕</button>
      <img :src="zoomUrl" class="w-full rounded-xl border border-slate-700 shadow-2xl">
    </div>
  </div>

  <script>
    function dashboard() {
      return {
        API: getApiBase(),
        token: getToken(),
        tenantId: getTenant(),
        isSuperAdmin: isAdmin(),
        section: 'galerie',
        breadcrumb: 'Administration',
        title: 'ScenarWall',
        theme: 'dark',
        userMenu: false,
        avatarUrl: getAvatar() || '',
        avatarInitial: 'A',
        displayName: getDisplayName() || '',
        // gallery
        visible: [],
        hidden: [],
        order: [],
        galleryLoading: true,
        uploadMessage: '',
        uploadStatus: 'ok',
        // audio
        audioFiles: [],
        audioLoading: false,
        audioMessage: '',
        audioStatus: 'ok',
        quotaDisplay: '—',
        quotaPercent: 0,
        zoomUrl: '',
        // tension
        tensionEnabled: true,
        tensionFont: 'Audiowide',
        defaultTensionColors: {
          level1: '#37aa32',
          level2: '#f8d718',
          level3: '#f39100',
          level4: '#e63027',
          level5: '#3a3a39'
        },
        defaultTensionLabels: {
          level1: '0',
          level2: '-5',
          level3: '+5',
          level4: '+10',
          level5: '+15'
        },
        tensionColors: {
          level1: '#37aa32',
          level2: '#f8d718',
          level3: '#f39100',
          level4: '#e63027',
          level5: '#3a3a39'
        },
        tensionLabels: {
          level1: '0',
          level2: '-5',
          level3: '+5',
          level4: '+10',
          level5: '+15'
        },
        tensionAudio: {
          level1: null,
          level2: null,
          level3: null,
          level4: null,
          level5: null
        },
        tensionMessage: '',
        tensionStatus: 'ok',
        tensionSavedAt: null,
        // godmode users
        users: [],
        usersLoading: false,
        hideInactiveUsers: false,
        hideInactiveQuota: false,
        userSort: { key: 'name', dir: 'asc' },
        quotaSort: { key: 'name', dir: 'asc' },
        // global quota
        globalQuotaValue: '',
        globalQuotaMessage: '',
        globalQuotaStatus: 'ok',

        init() {
          if (!this.token) {
            window.location.href = '/index.html';
            return;
          }
          try {
            const payload = JSON.parse(atob(this.token.split('.')[1] || ''));
            if (payload.email) this.avatarInitial = payload.email.charAt(0).toUpperCase();
            this.displayName = payload.displayName || payload.email || '';
            if (payload.avatarUrl) {
              this.avatarUrl = payload.avatarUrl;
              setAvatar(payload.avatarUrl);
            }
          } catch (e) {}

          if (!this.tenantId) {
            this.section = this.isSuperAdmin ? 'users' : 'galerie';
          }

          const storedTheme = localStorage.getItem('sw_theme');
          this.theme = storedTheme === 'light' ? 'light' : 'dark';

          this.refreshGallery();
          this.loadAudio();
          this.loadTension();
          this.fetchQuota();
          if (this.isSuperAdmin) {
            this.loadUsers();
            this.loadGlobalQuota();
          }
        },

        headersAuth() {
          return { 'Authorization': 'Bearer ' + this.token };
        },
        headersGod() {
          return { 'x-auth-token': this.token };
        },

        toggleTheme() {
          this.theme = this.theme === 'dark' ? 'light' : 'dark';
          localStorage.setItem('sw_theme', this.theme);
        },

        setBreadcrumb() {
          const map = {
            galerie: 'Galerie', audio: 'Audio', tension: 'Tension', users: 'Utilisateurs', quotas: 'Quotas'
          };
          this.breadcrumb = 'Administration / ' + (map[this.section] || '');
          this.title = map[this.section] || 'Administration';
        },

        // Gallery
        async refreshGallery() {
          if (!this.tenantId) return;
          this.galleryLoading = true;
          try {
            const res = await fetch(`${this.API}/api/tenant/${this.tenantId}/images`, { headers: this.headersAuth() });
            if (!res.ok) throw new Error('Images');
            const data = await res.json();
            this.visible = data.filter(i => !i.hidden);
            this.hidden = data.filter(i => i.hidden);
            this.order = this.visible.map(i => i.name);
          } catch (e) {
            this.visible = [];
            this.hidden = [];
          }
          this.galleryLoading = false;
        },
        async uploadFile(event) {
          const files = Array.from(event.target.files || []);
          event.target.value = '';
          if (!files.length || !this.tenantId) return;

          let success = 0;
          let errors = [];

          for (const file of files) {
            const form = new FormData();
            form.append('image', file);
            try {
              const res = await fetch(`${this.API}/api/${this.tenantId}/images/upload`, {
                method: 'POST',
                headers: this.headersAuth(),
                body: form
              });
              if (!res.ok) {
                const data = await res.json().catch(() => ({}));
                if (res.status === 400 && data.error === 'Quota exceeded') {
                  errors.push(`Quota dépassé pour ${file.name}`);
                  break;
                }
                errors.push(data.error || `Échec pour ${file.name}`);
              } else {
                success++;
              }
            } catch (err) {
              errors.push(`Réseau: ${file.name}`);
            }
          }

          if (success > 0) {
            await this.refreshGallery();
            await this.fetchQuota();
          } else {
            await this.fetchQuota();
          }

          if (errors.length === 0) {
            this.setUpload(`${success} image${success > 1 ? 's' : ''} uploadée${success > 1 ? 's' : ''} avec succès.`, 'ok');
          } else {
            const msg = [
              success > 0 ? `${success} image${success > 1 ? 's' : ''} ok.` : 'Aucune image envoyée.',
              errors.join(' | ')
            ].join(' ');
            this.setUpload(msg, 'error');
          }
        },
        setUpload(msg, status = 'ok') {
          this.uploadMessage = msg;
          this.uploadStatus = status;
        },
        async saveOrder() {
          await fetch(`${this.API}/api/${this.tenantId}/images/order`, {
            method: 'PUT',
            headers: { ...this.headersAuth(), 'Content-Type': 'application/json' },
            body: JSON.stringify({ order: this.order })
          });
        },
        async move(index, dir) {
          const newIndex = index + dir;
          if (newIndex < 0 || newIndex >= this.order.length) return;
          [this.order[index], this.order[newIndex]] = [this.order[newIndex], this.order[index]];
          await this.saveOrder();
          await this.refreshGallery();
        },
        async hideImage(name) {
          await fetch(`${this.API}/api/${this.tenantId}/images/hide/${name}`, { method: 'PUT', headers: this.headersAuth() });
          await this.refreshGallery();
          await this.fetchQuota();
        },
        async showImage(name) {
          await fetch(`${this.API}/api/${this.tenantId}/images/show/${name}`, { method: 'PUT', headers: this.headersAuth() });
          await this.refreshGallery();
          await this.fetchQuota();
        },
        async deleteImage(name) {
          if (!confirm('Supprimer définitivement cette image ?')) return;
          await fetch(`${this.API}/api/${this.tenantId}/images/${name}`, { method: 'DELETE', headers: this.headersAuth() });
          await this.refreshGallery();
          await this.fetchQuota();
        },
        zoom(url) { this.zoomUrl = url; },
        openFront() {
          if (!this.tenantId) return;
          window.open(`/t/${this.tenantId}/front`, '_blank');
        },
        formatBytes(bytes) {
          if (bytes === null || bytes === undefined) return '';
          const units = ['o', 'Ko', 'Mo'];
          let val = bytes;
          let i = 0;
          while (val >= 1024 && i < units.length - 1) {
            val = val / 1024;
            i++;
          }
          return `${val.toFixed(i === 0 ? 0 : 1)} ${units[i]}`;
        },

        // Audio
        async loadAudio() {
          if (!this.tenantId) return;
          this.audioLoading = true;
          try {
            const res = await fetch(`${this.API}/api/tenant/${this.tenantId}/audio`, { headers: this.headersAuth() });
            if (!res.ok) throw new Error('Audio');
            this.audioFiles = await res.json();
            this.audioStatus = 'ok';
          } catch (e) {
            this.audioFiles = [];
            this.audioStatus = 'error';
          }
          this.audioLoading = false;
        },
        async uploadAudio(event) {
          const files = Array.from(event.target.files || []);
          event.target.value = '';
          if (!files.length || !this.tenantId) return;
          let success = 0;
          const errors = [];
          for (const file of files) {
            if (file.size > 1 * 1024 * 1024) {
              errors.push(`${file.name} dépasse 1 Mo`);
              continue;
            }
            const form = new FormData();
            form.append('audio', file);
            try {
              const res = await fetch(`${this.API}/api/${this.tenantId}/audio/upload`, {
                method: 'POST',
                headers: this.headersAuth(),
                body: form
              });
              const data = await res.json().catch(() => ({}));
              if (!res.ok) {
                errors.push(data.error || `Échec pour ${file.name}`);
              } else {
                success++;
              }
            } catch (err) {
              errors.push(`Réseau: ${file.name}`);
            }
          }
          if (success > 0) {
            await this.loadAudio();
            await this.fetchQuota();
          } else {
            await this.fetchQuota();
          }
          this.audioStatus = errors.length ? 'error' : 'ok';
          if (errors.length === 0) {
            this.audioMessage = `${success} fichier${success > 1 ? 's' : ''} ajouté${success > 1 ? 's' : ''}.`;
          } else {
            const msg = [
              success > 0 ? `${success} fichier${success > 1 ? 's' : ''} ok.` : 'Aucun fichier ajouté.',
              errors.join(' | ')
            ].join(' ');
            this.audioMessage = msg;
          }
        },
        async deleteAudio(name) {
          if (!confirm('Supprimer définitivement cet audio ?')) return;
          try {
            await fetch(`${this.API}/api/${this.tenantId}/audio/${encodeURIComponent(name)}`, { method: 'DELETE', headers: this.headersAuth() });
            await this.loadAudio();
            await this.fetchQuota();
          } catch (err) {
            this.audioMessage = 'Suppression impossible.';
            this.audioStatus = 'error';
          }
        },
        async renameAudio(name) {
          const newName = prompt('Nouveau nom (avec extension .mp3/.wav/.ogg/.m4a/.aac)', name);
          if (!newName || newName === name) return;
          try {
            const res = await fetch(`${this.API}/api/${this.tenantId}/audio/${encodeURIComponent(name)}`, {
              method: 'PUT',
              headers: { ...this.headersAuth(), 'Content-Type': 'application/json' },
              body: JSON.stringify({ newName })
            });
            const data = await res.json().catch(() => ({}));
            if (!res.ok) throw new Error(data.error || 'Erreur');
            await this.loadAudio();
            this.audioMessage = 'Nom mis à jour.';
            this.audioStatus = 'ok';
          } catch (err) {
            this.audioMessage = err.message || 'Impossible de renommer.';
            this.audioStatus = 'error';
          }
        },

        // Quota
        async fetchQuota() {
          if (!this.tenantId) return;
          try {
            const res = await fetch(`${this.API}/api/${this.tenantId}/quota`, { headers: this.headersAuth() });
            if (!res.ok) throw new Error('Quota');
            const data = await res.json();
            const valueText = `${data.quotaMB} Mo`;
            const usageText = `${data.usage} Mo`;
            this.quotaDisplay = `${usageText} / ${valueText}`;
            this.quotaPercent = data.quotaMB > 0 ? Math.min(100, (data.usage / data.quotaMB) * 100) : 0;
          } catch (e) {
            this.quotaDisplay = '—';
            this.quotaPercent = 0;
          }
        },

        // Tension
        normalizeLocalColors(colors) {
          const sanitize = (c, fallback) => {
            const val = this.sanitizeColor(c);
            return val ? val : fallback;
          };
          return {
            level1: sanitize(colors?.level1, this.defaultTensionColors.level1),
            level2: sanitize(colors?.level2, this.defaultTensionColors.level2),
            level3: sanitize(colors?.level3, this.defaultTensionColors.level3),
            level4: sanitize(colors?.level4, this.defaultTensionColors.level4),
            level5: sanitize(colors?.level5, this.defaultTensionColors.level5)
          };
        },
        async loadTension() {
          if (!this.tenantId) return;
          try {
            const res = await fetch(`${this.API}/api/${this.tenantId}/config`, { headers: this.headersAuth() });
            if (!res.ok) throw new Error('Config');
            const data = await res.json();
            this.tensionEnabled = data.tensionEnabled !== false;
            this.tensionFont = data.tensionFont ?? 'Audiowide';
            this.tensionColors = this.normalizeLocalColors(data.tensionColors);
            this.tensionLabels = this.normalizeLocalLabels(data.tensionLabels);
            this.tensionAudio = data.tensionAudio || { ...this.tensionAudio };
            this.tensionMessage = 'Configuration chargée.';
            this.tensionStatus = 'ok';
          } catch (err) {
            this.tensionColors = { ...this.defaultTensionColors };
            this.tensionLabels = { ...this.defaultTensionLabels };
            this.tensionMessage = 'Impossible de charger la configuration.';
            this.tensionStatus = 'error';
          }
        },
        sanitizeColor(hex) {
          const h = (hex || '').toString().trim().toLowerCase();
          const normalized = h.startsWith('#') ? h : `#${h}`;
          const short = normalized.match(/^#([0-9a-fA-F]{3})$/);
          if (short) {
            const c = short[1];
            return `#${c[0]}${c[0]}${c[1]}${c[1]}${c[2]}${c[2]}`.toLowerCase();
          }
          return /^#([0-9a-fA-F]{6})$/.test(normalized) ? normalized : null;
        },
        normalizeLocalLabels(labels) {
          const clamp = (v, fb) => {
            if (typeof v !== 'string') return fb;
            const s = v.trim().slice(0, 4);
            return s.length ? s : fb;
          };
          const src = labels || {};
          return {
            level1: clamp(src.level1, this.defaultTensionLabels.level1),
            level2: clamp(src.level2, this.defaultTensionLabels.level2),
            level3: clamp(src.level3, this.defaultTensionLabels.level3),
            level4: clamp(src.level4, this.defaultTensionLabels.level4),
            level5: clamp(src.level5, this.defaultTensionLabels.level5),
          };
        },
        async toggleTension() {
          // legacy alias kept to avoid breaking bindings
          return this.saveTensionConfig();
        },
        async saveTensionConfig() {
          if (!this.tenantId) return;
          try {
            const colors = this.normalizeLocalColors(this.tensionColors);
            const labels = this.normalizeLocalLabels(this.tensionLabels);
            const res = await fetch(`${this.API}/api/${this.tenantId}/config/tension`, {
              method: 'PUT',
              headers: { ...this.headersAuth(), 'Content-Type': 'application/json' },
              body: JSON.stringify({
                tensionEnabled: this.tensionEnabled,
                tensionFont: this.tensionFont,
                tensionColors: colors,
                tensionLabels: labels,
                tensionAudio: this.tensionAudio
              })
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.error || 'Erreur');
            this.tensionEnabled = data.config?.tensionEnabled !== false;
            this.tensionFont = data.config?.tensionFont || null;
            this.tensionColors = data.config?.tensionColors || colors;
            this.tensionLabels = data.config?.tensionLabels || labels;
            this.tensionAudio = data.config?.tensionAudio || this.tensionAudio;
            this.tensionMessage = this.tensionEnabled ? 'Barre de tension activée.' : 'Barre de tension désactivée.';
            this.tensionStatus = 'ok';
            this.tensionSavedAt = new Date().toLocaleTimeString();
            setTimeout(() => { this.tensionSavedAt = null; }, 3000);
          } catch (err) {
            this.tensionMessage = err.message || 'Erreur réseau.';
            this.tensionStatus = 'error';
          }
        },

        // GodMode users
        usageData(u) {
          const usageMB = u.quotaUsedBytes ? (u.quotaUsedBytes / 1024 / 1024) : 0;
          const quotaMB = u.quotaMB || 0;
          const percent = quotaMB > 0 ? Math.min(100, (usageMB / quotaMB) * 100) : 0;
          const text = quotaMB ? `${usageMB.toFixed(2)} / ${quotaMB} Mo${u.quotaOverride ? ' (perso)' : ''}` : `${usageMB.toFixed(2)} Mo (quota non défini)`;
          return { usageMB, quotaMB, percent, text };
        },
        usageTitle(u) {
          const { usageMB, quotaMB, percent } = this.usageData(u);
          return quotaMB ? `${usageMB.toFixed(2)} / ${quotaMB} Mo (${percent.toFixed(1)}%)` : `${usageMB.toFixed(2)} Mo (quota non défini)`;
        },
        totalUsageText() {
          const total = (this.users || []).reduce((sum, u) => sum + this.usageData(u).usageMB, 0);
          return `${total.toFixed(2)} Mo`;
        },
        sortValue(u, key) {
          const { usageMB } = this.usageData(u);
          switch (key) {
            case 'name': return (u.displayName || u.email || '').toLowerCase();
            case 'email': return (u.email || '').toLowerCase();
            case 'images': return u.imageCount || 0;
            case 'audios': return u.audioCount || 0;
            case 'usage': return usageMB;
            case 'lastLogin': return u.lastLogin ? new Date(u.lastLogin).getTime() : 0;
            default: return 0;
          }
        },
        sortList(list, conf) {
          const f = conf.dir === 'asc' ? 1 : -1;
          return [...list].sort((a, b) => {
            const va = this.sortValue(a, conf.key);
            const vb = this.sortValue(b, conf.key);
            if (va < vb) return -1 * f;
            if (va > vb) return 1 * f;
            return 0;
          });
        },
        filteredUsers(mode) {
              let list = mode === 'quota' ? this.users : this.users;
          const sortConf = mode === 'users' ? this.userSort : this.quotaSort;
          return this.sortList(list, sortConf);
        },
        setUserSort(key) {
          if (this.userSort.key === key) {
            this.userSort.dir = this.userSort.dir === 'asc' ? 'desc' : 'asc';
          } else {
            this.userSort = { key, dir: 'asc' };
          }
        },
        setQuotaSort(key) {
          if (this.quotaSort.key === key) {
            this.quotaSort.dir = this.quotaSort.dir === 'asc' ? 'desc' : 'asc';
          } else {
            this.quotaSort = { key, dir: 'asc' };
          }
        },
        sortIcon(key, mode) {
          const conf = mode === 'users' ? this.userSort : this.quotaSort;
          if (conf.key !== key) return 'fa-solid fa-sort text-slate-400';
          return conf.dir === 'asc' ? 'fa-solid fa-sort-up text-emerald-500' : 'fa-solid fa-sort-down text-emerald-500';
        },
        async loadUsers() {
          this.usersLoading = true;
          try {
            const res = await fetch(`${this.API}/api/godmode/users`, { headers: this.headersGod() });
            if (!res.ok) throw new Error('Users');
            this.users = await res.json();
          } catch (e) {
            this.users = [];
          }
          this.usersLoading = false;
        },
        async deleteUser(email) {
          if (!confirm('Supprimer définitivement ce compte ?')) return;
          await fetch(`${this.API}/api/godmode/user/${email}`, {
            method: 'DELETE',
            headers: { ...this.headersGod(), 'Content-Type': 'application/json' }
          });
          this.loadUsers();
        },
        async loadGlobalQuota() {
          try {
            const res = await fetch(`${this.API}/api/godmode/global-quota`, { headers: this.headersGod() });
            if (!res.ok) throw new Error('Global');
            const data = await res.json();
            this.globalQuotaValue = data.defaultQuotaMB || '';
            this.globalQuotaMessage = '';
          } catch (e) {
            this.globalQuotaMessage = 'Impossible de charger le quota global.';
            this.globalQuotaStatus = 'error';
          }
        },
        async saveGlobalQuota() {
          const value = parseFloat(this.globalQuotaValue);
          if (Number.isNaN(value) || value <= 0) {
            this.globalQuotaMessage = 'Entrez une valeur valide (>0).';
            this.globalQuotaStatus = 'error';
            return;
          }
          try {
            const res = await fetch(`${this.API}/api/godmode/global-quota`, {
              method: 'PUT',
              headers: { ...this.headersGod(), 'Content-Type': 'application/json' },
              body: JSON.stringify({ defaultQuotaMB: value })
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.error || 'Erreur');
            this.globalQuotaMessage = 'Quota global mis à jour.';
            this.globalQuotaStatus = 'ok';
            this.loadUsers();
          } catch (err) {
            this.globalQuotaMessage = err.message || 'Échec de la mise à jour.';
            this.globalQuotaStatus = 'error';
          }
        },
        async editTenantQuota(u) {
          const defaultVal = u.quotaOverride ? u.quotaMB : '';
          const input = prompt('Quota en Mo (laisser vide pour quota global)', defaultVal);
          if (input === null) return;
          const trimmed = input.trim();
          let payloadValue = null;
          if (trimmed !== '') {
            const num = parseFloat(trimmed);
            if (Number.isNaN(num) || num <= 0) {
              alert('Veuillez saisir un nombre positif ou laisser vide.');
              return;
            }
            payloadValue = num;
          }
          try {
            const res = await fetch(`${this.API}/api/godmode/tenant-quota`, {
              method: 'PUT',
              headers: { ...this.headersGod(), 'Content-Type': 'application/json' },
              body: JSON.stringify({ tenantId: u.tenantId || '', quotaMB: payloadValue })
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.error || 'Erreur');
            this.loadUsers();
          } catch (err) {
            alert(err.message || 'Impossible de mettre à jour le quota.');
          }
        },

      };
    }
  </script>
</body>
</html>
