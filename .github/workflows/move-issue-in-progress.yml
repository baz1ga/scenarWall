name: Move Issue to In Progress

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'

jobs:
  move_issue:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Extract issue number from commit
        id: extract
        run: |
          MSG="$(git log -1 --pretty=%B)"
          echo "Commit message: $MSG"
          if [[ "$MSG" =~ \[([0-9]+)\] ]]; then
            echo "ISSUE_NUMBER=${BASH_REMATCH[1]}" >> $GITHUB_ENV
            echo "Detected issue number: ${BASH_REMATCH[1]}"
          else
            echo "ISSUE_NUMBER=" >> $GITHUB_ENV
            echo "No issue reference found."
          fi

      - name: Stop if no issue number found
        if: ${{ env.ISSUE_NUMBER == '' }}
        run: |
          echo "No issue detected. Skipping."
          exit 0

      - name: Fetch issue node ID
        id: fetch_issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ env.ISSUE_NUMBER }}
        run: |
          ISSUE_ID=$(gh api graphql -f query='
            query($repo:String!, $owner:String!, $num:Int!) {
              repository(name: $repo, owner: $owner) {
                issue(number: $num) { id }
              }
            }
          ' -F repo="${GITHUB_REPOSITORY#*/}" -F owner="${GITHUB_REPOSITORY%/*}" -F num="$ISSUE_NUMBER" --jq '.data.repository.issue.id')
          echo "ISSUE_ID=$ISSUE_ID" >> $GITHUB_ENV
          echo "Issue GraphQL node ID = $ISSUE_ID"

      - name: Move issue to In Progress
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_ID: ${{ env.ISSUE_ID }}
        run: |
          echo "Moving issue to In Progressâ€¦"

          gh api graphql -f query='
            mutation($project:ID!, $item:ID!, $field:ID!, $option:String!) {
              updateProjectV2ItemFieldValue(
                input: {
                  projectId: $project,
                  itemId: $item,
                  fieldId: $field,
                  value: { singleSelectOptionId: $option }
                }
              ) {
                projectV2Item { id }
              }
            }
          ' \
            -F project="PVT_kwHOBJv2Rc4BI-_3" \
            -F item="$ISSUE_ID" \
            -F field="Status" \
            -F option="47fc9ee4"
